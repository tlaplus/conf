<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=generator content="Hugo 0.85.0"><meta name=description content><meta name=author content="Markus Kuppe"><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=icon href=/images/favicon.png type=image/x-icon><title>YannickWelsch :: TLA+ Community Event & Conference</title><link href=/css/nucleus.css rel=stylesheet><link href=/css/font-awesome.min.css rel=stylesheet><link href=/css/hybrid.css rel=stylesheet><link href=/css/featherlight.min.css rel=stylesheet><link href=/css/perfect-scrollbar.min.css rel=stylesheet><link href=/css/auto-complete.css rel=stylesheet><link href=/css/theme.css rel=stylesheet><link href=/css/hugo-theme.css rel=stylesheet><script src=/js/jquery-2.x.min.js></script><style type=text/css>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/2019/yannickwelsch/><nav id=sidebar><div id=header-wrapper><div id=header><img src=/tlalogo.jpg alt="TLA+ Logo"></div></div><div class=highlightable><ul class=topics><li data-nav-id=/home/ title=Home class=dd-item><a href=/home/>Home</a></li><li data-nav-id=/202110/ title="2021 - TLA+ Tutorial" class=dd-item><a href=/202110/>2021 - TLA+ Tutorial</a></li><li data-nav-id=/2021/ title="2021 - TLA+ Conf" class=dd-item><a href=/2021/>2021 - TLA+ Conf</a><ul></ul></li><li data-nav-id=/2020/ title="2020 - TLA+ Community Event" class=dd-item><a href=/2020/>2020 - TLA+ Community Event</a></li><li data-nav-id=/2019/ title="2019 - TLA+ Conf" class="dd-item
parent"><a href=/2019/>2019 - TLA+ Conf</a><ul></ul></li></ul><section id=footer><li data-nav-id=/2018/ title="2018 - TLA+ Community Event" class=dd-item><a href=http://tla2018.loria.fr/>2018 - TLA+ Community Event</a></li><li data-nav-id=/2014/ title="2014 - TLA+ Community Event" class=dd-item><a href=http://tla2014.loria.fr/>2014 - TLA+ Community Event</a></li><li data-nav-id=/2012/ title="2012 - TLA+ Community Event" class=dd-item><a href=http://tla2012.loria.fr/>2012 - TLA+ Community Event</a></li><h4>Contact</h4>"tla2021" \o "@" \o "tlapl.us"</section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable sticky-parent"><div class=sticky-spacer><div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fa fa-bars"></i></a></span>
<span id=toc-menu><i class="fa fa-list-alt"></i></span>
<span class=links><a href=/>TLA+ Community Event & Conference</a> > <a href=/2019/>2019 - TLA+ Conf</a> > YannickWelsch</span></div><div align=right><h4>TLA<sup>+</sup> Tutorial @ DISC<br>Friday, October 8, 2021<br>Virtual (CEST)<br></h4></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#using-tla-for-fun-and-profit-in-the-development-of-elasticsearch>Using TLA+ for fun and profit in the development of Elasticsearch</a></li></ul></li></ul></nav></div></div></div></div><div id=body-inner><h3 id=using-tla-for-fun-and-profit-in-the-development-of-elasticsearch>Using TLA+ for fun and profit in the development of Elasticsearch</h3><h4 id=yannick-welsch>Yannick Welsch</h4><h5 id=elastic>Elastic</h5><p><a href=https://github.com/elastic/elasticsearch>Elasticsearch</a> is a distributed search and analytics engine based on <a href=https://lucene.apache.org/>Apache Lucene</a>. Initially
released in 2010, it has quickly become the <a href=https://db-engines.com/en/ranking/search+engine>most popular</a> enterprise search engine, and
is commonly used for log analytics, full-text search, operational and security intelligence,
business analytics, and metrics use cases. Built as a distributed system since its inception,
Elasticsearch effortlessly scales to clusters of hundreds of servers. As part of a larger
resiliency effort, Elasticsearchâ€™s core cluster coordination and data replication algorithms
have undergone major overhauls in recent years. The use of formal methods, with in
particular <a href=http://lamport.azurewebsites.net/tla/tla.html>TLA+, PlusCal and the TLC model checker</a>, has extensively contributed to
the goal of creating a much safer and resilient system. This presentation will provide an
overview on the various uses of TLA + during the development of Elasticsearch:</p><ul><li><p>We refined and validated an informal specification of the <a href=https://www.elastic.co/blog/elasticsearch-sequence-ids-6-0>data replication algorithm</a>
that has been powering Elasticsearch since version 6, released in November 2017, by
creating a <a href=https://github.com/elastic/elasticsearch-formal-models/blob/master/data/tla/replication.tla>TLA+ specification</a> during the implementation effort. This algorithm, based
on the primary-backup approach, enables high-throughput sharded data ingestion
pipelines and has served as fundational work to build newer features such as <a href=https://www.elastic.co/blog/follow-the-leader-an-introduction-to-cross-cluster-replication-in-elasticsearch>cross-datacenter replication</a>.</p></li><li><p>We studied <a href=https://github.com/elastic/elasticsearch/pull/28787>two</a> <a href=https://github.com/elastic/elasticsearch/pull/28790>bugs</a> in a highly concurrent component that handles deletion tomb-
stones and out-of-order writes under various optimizations. The implementation was
mapped onto a <a href=https://github.com/elastic/elasticsearch-formal-models/blob/master/ReplicaEngine/tla/ReplicaEngine.tla>PlusCal spec</a>, which, with the use of the TLC model checker, led
us to discover an additional unknown bug in the implementation, which we only
later <a href=https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404722753>observed</a> in the wild. The <a href=https://github.com/elastic/elasticsearch/pull/29619/files#diff-1a19a661d8e349460d8f8ae99cbe1274R318>bug fixes</a> were first <a href=https://github.com/elastic/elasticsearch-formal-models/pull/29/commits/893a0edbce86b2e114ea59de4170c838024fc6ac>prototyped</a> using the PlusCal
specification.</p></li><li><p>We designed a <a href=https://www.elastic.co/blog/a-new-era-for-cluster-coordination-in-elasticsearch>new cluster coordination</a> subsystem and validated it with TLA + before starting off our implementation efforts. This new cluster coordination subsystem
is powering all Elasticsearch clusters since version 7, released in April 2019. The
<a href=https://github.com/elastic/elasticsearch-formal-models/blob/ca26d5cb4ce9fd8c8b032a11bc849b52a812b6e5/ZenWithTerms/tla/ZenWithTerms.tla>TLA+ specification</a> is modeling the core safety bits of the consensus algorithm with
dynamic reconfiguration. The <a href=https://github.com/elastic/elasticsearch/blob/a1fcb8a7e6c6880ae72273f7b336450af42aae2b/server/src/main/java/org/elasticsearch/cluster/coordination/CoordinationState.java>implementation</a> of this core safety module has a direct
one-to-one mapping with the TLA + specification.</p></li><li><p>Our chaos-monkey style test infrastructure discovered a <a href=https://github.com/elastic/elasticsearch/pull/40519>bug</a> in the cluster state
storage layer that was related to the atomic persistence of state. This only surfaced
through randomized testing after running for months on our <a href=https://elasticsearch-ci.elastic.co/>CI infrastructure</a>. The
implementation was mapped onto a <a href=https://github.com/elastic/elasticsearch-formal-models/blob/master/Storage/tla/Storage.tla>TLA+ model</a> to rule out other such bugs. The
TLC model checker was able to find this bug within seconds.</p></li></ul><p>All Elasticsearch TLA + specifications are open-source and publicly available on our <a href=https://github.com/elastic/elasticsearch-formal-models>Github repository</a>, just as the <a href=https://github.com/elastic/elasticsearch>actual system</a> that is modeled.</p><footer class=footline></footer></div></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/perfect-scrollbar.min.js></script><script src=/js/perfect-scrollbar.jquery.min.js></script><script src=/js/html5shiv-printshiv.min.js></script><script src=/js/modernizr.custom.71422.js></script><script src=/js/learn.js></script><script src=/js/hugo-learn.js></script><link href=/mermaid/mermaid.css type=text/css rel=stylesheet><script src=/mermaid/mermaid.js></script><script>mermaid.initialize({startOnLoad:!0})</script><link href=/css/bootstrap.css rel=stylesheet><script src=/js/bootstrap.min.js></script></body></html>